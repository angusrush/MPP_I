\documentclass[main.tex]{subfiles}

\begin{document}

\section{Application to presheaves}
\label{sec:application_to_presheaves}

\subsection{Introduction}
\label{ssc:introduction}

Consider the $\infty$-category $\S$ of spaces. By \cite[Lemma 6.1.1.1]{highertopostheory} and \cite[Lemma 2.4.7.12]{highertopostheory}, the functor
\begin{equation}
  \label{eq:ev1}
  \ev_{1}\colon \Map(\Delta^{1}, \S) \to \S
\end{equation}
is a bicartesian fibration. For each edge $f\colon \Delta^{1} \to \S$, corresponding to a morphism $f\colon X \to Y$ of spaces, the fiber of $\ev_{1}$ over $f$ corresponds to a pair of adjoint functors
\begin{equation*}
  f_{!} : \S^{/X} \longleftrightarrow \S^{/Y} : f^{*}.
\end{equation*}
Interpreting $\S^{/X}$ as models for the $\P(X)$, the $\infty$-categories of presheaves on $X$, the functor $f^{*}$ corresponds to the functor which restricts along $f$, taking a presheaf $Y \to \S$ to the pullback $X \to Y \to \S$. The functor $f_{!}$ takes a preasheaf $X \to \S$ to its left Kan extension along $X \to Y$.

In this section, we apply the construction of the previous chapter to build from these data a functor
\begin{equation}
  \label{eq:rhat}
  \hat{r}\colon \Span(\S) \to \ICat.
\end{equation}
This functor will take a space $X$ to the category $\P(X)$ of presheaves on $X$, and a span of spaces
\begin{equation*}
  \begin{tikzcd}
    & Y
    \arrow[dl, swap, "g"]
    \arrow[dr, "f"]
    \\
    X
    && X'
  \end{tikzcd}
\end{equation*}
to the map $\P(X) \to \P(X')$ given by the composition
\begin{equation*}
  \begin{tikzcd}
    & \P(Y)
    \arrow[dr, "f^{*}"]
    \\
    \P(X)
    \arrow[ur, "g_{!}"]
    \arrow[rr, "f^{*} \circ g_{!}"]
    && \P(X').
  \end{tikzcd}.
\end{equation*}

Note that the category $\S$ has products. This induces a symmetric monoidal structure on $\S$, the cartesian monoidal structure, which (as we will see) induces a symmetric monoidal structure on $\Span(\S)$. When we take $\Cat_{\infty}$ also to carry the cartesian monoidal structure, we will see that our functor $\hat{r}$ (\hyperref[eq:rhat]{Equation~\ref*{eq:rhat}}) is even lax monoidal.

The idea behind the construction of the functor $\hat{r}$, in broad strokes, is as follows. We dress up the functor $\ev_{1}$, making it into a symmetric monoidal functor as follows (the monoidal structures on $\Map(\Delta^{1}, \S)^{\otimes}$ and $\S^{\otimes}$ are not exactly the standard cocartesian monoidal functors, as we will later discuss; they are represented by \emph{cartesian,} rather than \emph{cocartesian} fibrations).
\begin{equation}
  \label{eq:wishlist_prq}
  \begin{tikzcd}
    \Map(\Delta^{1}, \S)^{\otimes}
    \arrow[rr, "r"]
    \arrow[dr, swap, "q"]
    && \S^{\otimes}
    \arrow[dl, "p"]
    \\
    & \Finp\op
  \end{tikzcd}
\end{equation}

We then take spans in each of these categories, restricting the backwards- and forwards-facing legs judiciously so that we get a diagram
\begin{equation}
  \label{eq:wishlist_pivarpirho}
  \begin{tikzcd}
    \Span'(\Map(\Delta^{1}, \S))^{\otimes}
    \arrow[rr, "\rho"]
    \arrow[dr, swap, "\varpi"]
    && \Span(\S)^{\otimes}
    \arrow[dl, "\pi"]
    \\
    & \Finp
  \end{tikzcd},
\end{equation}
where the $\varpi$ and $\pi$ are symmetric monoidal structures and $\rho$ is a cocartesian fibration. In the language of \cite{luriehigheralgebra}, $\rho$ exhibits $\Span(\Map(\Delta^{1}, \S))$ as a $\Span(\S)$-monoidal category. Restricting to the component of $\rho$ over $\langle 1 \rangle \in \Finp$, one finds a cocartesian fibration, which classifies a functor $\Span(\S) \to \ICat$. By \cite{luriehigheralgebra}, 2.4.2.4--2.4.2.6, this functor is lax monoidal, giving us our functor $\hat{r}$.

Much of the technology in this section is similar to work already done in \cite{spectralmackeyfunctors2}. However, the manner in which we present it allows for generalization in a different direction than that carried out there. This will be the subject of future work.

\subsection{Defining the maps \texorpdfstring{$p$}{p}, \texorpdfstring{$q$}{q}, and \texorpdfstring{$r$}{r}}
\label{ssc:defining_the_maps_p_q_and_r}

Recall that for any $\infty$-category $\category{C}$ with finite products, one can construct a symmetric monoidal structure $\category{C}^{\times} \to \Finp$ whose corresponding tensor product $\times\colon \category{C} \times \category{C} \to \category{C}$ is the cartesian product; for more details, see \cite[Sec.\ 2.4.1]{luriehigheralgebra}. Similarly, as described in \cite[Sec.\ 2.4.2]{luriehigheralgebra}, for any $\infty$-category with coproducts there is a symmetric monoidal structure $\category{C}^{\amalg} \to \Finp$, called the \emph{cocartesian monoidal structure,} whose tensor product $\amalg\colon \category{C} \times \category{C} \to \category{C}$ is the coproduct. Because cocartesian fibrations give better control of the morphisms out of an object than morphisms into an object, the cocartesian monoidal structure is much more tractable than the cartesian monoidal structure.

Since taking coproducts in $\category{C}\op$ is the same as taking products in $\category{C}$, we can express the cartesian monoidal structure on $\category{C}$ as a cartesian fibration rather than a cocartesian fibration by taking the opposite of the cocartesian monoidal structure on $\category{C}\op$. In the case $\category{C} = \S$, this gives us the monoidal structure we are interested in.

\begin{definition}
  We define the map $p\colon \S_{\times} \to \Finp\op$ to be the functor
  \begin{equation*}
    ((\S\op)^{\amalg} \to \Finp)\op,
  \end{equation*}
  where $(\S\op)^{\amalg} \to \Finp$ is the cocartesian monoidal structure, as described in \cite[Sec.\ 2.4.2]{luriehigheralgebra}.
\end{definition}

In low degrees, the category $\S_{\times}$ admits the following description.
\begin{itemize}
  \item The objects are pairs $(\langle n \rangle, \vec{X})$, where $\langle n \rangle$ is an object of $\Finp$, and $\vec{X} = [X_{1}, \ldots, X_{n}]$ is an ordered $n$-tuple of objects of $\S$.

  \item The morphisms $(\langle m \rangle, \vec{X}) \to (\langle n \rangle, \vec{Y})$ are pairs $(\phi, \Psi)$, where $\phi\colon \langle n \rangle \to \langle m \rangle$ is a morphism in $\Finp$, and $\Psi$ consists, for each $i \in \langle m \rangle^{\circ}$, of a collection of morphisms $X_{i} \to Y_{j}$ for each $j \in \langle n \rangle^{\circ}$ with $\phi(j) = i$.
\end{itemize}

The functor $\S_{\times} \to \Finp\op$ is the obvious forgetful functor.

\begin{example}
  \label{eg:morphisms_in_cocartesian_monoidal_structure_on_spaces}
  An object $(\langle 1 \rangle, \vec{X})$ of $\S_{\times}$ in the fiber over $\langle 1 \rangle \in \Finp\op$ is the same thing as an object $X \in \langle S \rangle$. An object $( \langle 2 \rangle, \vec{Y})$ in the fiber over $\langle 2 \rangle$ is the same as a pair of objects $[Y, Y']$ in $\S$.

  A morphism $(\phi, \Psi)\colon (\langle 1 \rangle, \vec{X}) \to (\langle 2 \rangle, \vec{Y})$ where $\phi\colon \langle 2 \rangle \to \langle 1 \rangle$ is the morphism in $\Finp$ which sends $1 \mapsto 1$, $2 \mapsto 1$, consists of a pair of maps $X \to Y$, $X \to Y'$.
  \begin{equation*}
    \begin{tikzcd}[row sep=tiny]
      & 1
      \arrow[dl, mapsto]
      \\
      1
      \\
      & 2
      \arrow[ul, mapsto]
    \end{tikzcd}
    \qquad\qquad
    \begin{tikzcd}[row sep=tiny]
      & Y
      \\
      X
      \arrow[ur]
      \arrow[dr]
      \\
      & Y'
    \end{tikzcd}
  \end{equation*}
\end{example}

\begin{lemma}
  The map $p$ is a cartesian fibration, and a morphism $(\phi, \Psi)\colon (\langle m \rangle, \vec{X}) \to (\langle n \rangle, \vec{Y})$ in $\S_{\times}$ is $p$-cartesian if and only if it for each $i \in \langle m \rangle^{\circ}$, the maps $X_{i} \to Y_{j}$ exhibit $X_{i}$ as the product of the $Y_{j}$.
\end{lemma}
\begin{proof}
  This follows easily from the definition of the cocartesian monoidal structure.
\end{proof}

\begin{example}
  The morphism described in \hyperref[eg:morphisms_in_cocartesian_monoidal_structure_on_spaces]{Example~\ref*{eg:morphisms_in_cocartesian_monoidal_structure_on_spaces}} is cartesian if and only if $X \simeq Y \times Y'$, and the maps $X \to Y$ and $X \to Y'$ are the canonical projections.
\end{example}

We can now define the maps $q$ and $r$ rather easily.

\begin{definition}
  We define maps $q$ and $r$ via the following diagram, where the left-hand square is pullback. In particular, the space $\Map(\Delta^{1}, \S)_{\times}$ is defined to be the (strict) pullback below.
  \begin{equation*}
    \begin{tikzcd}
      \Map(\Delta^{1}, \S)_{\times}
      \arrow[r, hook]
      \arrow[rr, bend left, "r"]
      \arrow[d, swap, "q"]
      & \Map(\Delta^{1}, \S_{\times})
      \arrow[r, "\ev_{1}"]
      \arrow[d]
      & \S_{\times}
      \arrow[d, "p"]
      \\
      \Finp\op
      \arrow[r, hook]
      \arrow[rr, bend right, swap, "\id"]
      & \Map(\Delta^{1}, \Finp\op)
      \arrow[r, "\ev_{1}"]
      & \Finp\op
    \end{tikzcd}
  \end{equation*}
\end{definition}

\begin{lemma}
  The map $q$ is a cartesian fibration, and the cartesian morphisms are those which are level-wise cartesian morphisms in $\S_{\times}$.
\end{lemma}
\begin{proof}
  The map $q$ is given by the pullback
  \begin{equation*}
    \begin{tikzcd}
      \Map(\Delta^{1}, \category{S})_{\times}
      \arrow[r, hook]
      \arrow[d, swap, "q"]
      & \Map(\Delta^{1}, \category{S}_{\times})
      \arrow[d, "q'"]
      \\
      \Finp\op
      \arrow[r, hook]
      & \Map(\Delta^{1}, \Finp\op)
    \end{tikzcd}.
  \end{equation*}
  By \cite[Prop.\ 3.1.2.1]{highertopostheory}, the map $q'$ is a cartesian fibration whose cartesian morphisms are pointwise cartesian morphisms in $\S_{\times}$. The map $q$ is also a cartesian fibration, where a morphism in $\Map(\Delta^{1}, \S)_{\times}$ is $q$-cartesian if and only if its image in $\Map(\Delta^{1}, \S_{\times})$ is $q'$-cartesian. That every $q$ cartesian morphism is $q'$ cartesian follows from \cite[Prop\ 2.4.1.3]{highertopostheory}; to see other direction, consider a $q$-cartesian morphism $g$ in $\Map(\Delta^{1}, \S)_{\times}$. Its image $\tilde{g}\Map(\Delta^{1}, \S_{\times})$ lies over some morphism $\phi$, and this morphism 
\end{proof}

\begin{lemma}
  \label{lemma:map_on_cartesian_cats_is_bicart_fib}
  The map $r$ is a bicartesian fibration with $r$-cartesian morphisms pullback squares in $\S_{\times}$ and $r$-cocartesian morphisms squares of the form
  \begin{equation*}
    \begin{tikzcd}
      X
      \arrow[r, "\simeq"]
      \arrow[d]
      & Y
      \arrow[d]
      \\
      X'
      \arrow[r]
      & Y'
    \end{tikzcd}.
  \end{equation*}
\end{lemma}
\begin{proof}
  The map $r$ factors into
  \begin{equation*}
    \begin{tikzcd}
      \Map(\Delta^{1}, \S)_{\times}
      \arrow[r, hook, "j"]
      & \Map(\Delta^{1}, \S_{\times})
      \arrow[r, "\ev_{1}"]
      & \S_{\times}
    \end{tikzcd}
  \end{equation*}
  The map $\ev_{1}$ is a bicartesian fibration with the cartesian and cocartesian morphisms described above; the map $j$ is a full inclusion (in the sense of \hyperref[def:full_inclusion]{Definition~\ref*{def:full_inclusion}}), and therefore has the right-lifting property with respect to \emph{all} horn inclusions $\Lambda^{n}_{i} \hookrightarrow \Delta^{n}$, $n \geq 2$ (because $\Lambda^{n}_{i}$ contains all vertices for $n \geq 2$). Every edge in $\Map(\Delta^{1}, \S)_{\times}$ is therefore both $j$-cartesian and $j$-cocartesian. \cite[Prop\ 2.4.1.3.3]{highertopostheory} implies that an edge in $\Map(\Delta^{1}, \S)_{\times}$ is $r$-cartesian (resp.\ cocartesian) if and only if its image in $\Map(\Delta^{1}, \S_{\times})$ is $\ev_{1}$-cartesian (resp.\ cocartesian).
\end{proof}

Let us take stock. We have now defined the data of the commutative diagram below. Here, $p$ and $q$ are cartesian fibrations, and $r$ is a bicartesian fibration.
\begin{equation}
  \label{eq:data_of_pqr}
  \begin{tikzcd}
    \Map(\Delta^{1}, \S)_{\times}
    \arrow[rr, "r"]
    \arrow[dr, swap, "q"]
    && \S_{\times}
    \arrow[dl, "p"]
    \\
    & \Finp\op
  \end{tikzcd}
\end{equation}
Our next step is to take spans with judiciously-chosen legs in each of these quasicategories. To do this, we must define the subcategories to which the legs of our spans are allowed to belong. As in \hyperref[sec:segal_spaces_of_spans]{Section~\ref*{sec:segal_spaces_of_spans}}, we do this by defining triples of categories.

\subsection{Restricting the legs of the spans}
\label{ssc:restricting_the_legs_of_the_spans}

In this section, we define triple structures on the quasicategories $\Map(\Delta^{1}, \S)_{\times}$, $\S_{\times}$, and $\Finp\op$.

\subsubsection*{Triple structure on \texorpdfstring{$\Finp\op$}{Fin.op}}

Let us cast our minds back to \hyperref[ssc:introduction]{Subsection~\ref*{ssc:introduction}}. We have cartesian fibrations $p$, $q$, and $r$ as in \hyperref[eq:data_of_pqr]{Diagram~\ref*{eq:data_of_pqr}}; these play the role of the maps alluded to in \hyperref[eq:wishlist_prq]{Diagram~\ref*{eq:wishlist_prq}}. We would like a triple structure on $\Finp\op$ such that, when passing to quasicategories of spans, we find \emph{cocartesian fibrations} of the form \hyperref[eq:wishlist_pivarpirho]{Diagram~\ref*{eq:wishlist_pivarpirho}}.

This means, in particular, that we want a triple structure on $\Finp\op$ which gives us something like $\Finp$ upon taking categories of spans. Thus, we should take spans whose forward-pointing legs are equivalences:
\begin{equation*}
  \begin{tikzcd}
    \langle m \rangle
    \arrow[r]
    & \langle n \rangle
    & \langle n \rangle
    \arrow[l, swap, "\simeq"]
  \end{tikzcd}.
\end{equation*}

The following definition does precisely that.

\begin{definition}
  We define a triple $\triple{F}$ as follows.
  \begin{itemize}
    \item $\mathcal{F} = \Finp\op$

    \item $\mathcal{F}\downdag = (\Finp\op)^{\simeq}$

    \item $\mathcal{F}\updag = \Finp\op$
  \end{itemize}
\end{definition}

This is the triple structure considered in \hyperref[eg:spans_with_equivalences_on_forwards_leg]{Example~\ref*{eg:spans_with_equivalences_on_forwards_leg}}. There, we saw that the corresponding category of spans, which we called $\Span_{\simeq}(\Finp\op)$, was equivalent to $\Finp$. More precisely, we showed the following.

\begin{lemma}
  There is a weak Joyal equvialence
  \begin{equation*}
    \Finp \to \Span\triple{F},
  \end{equation*}
  which sends an $n$-simplex $\langle m \rangle \to \langle n \rangle \to \cdots \to \langle p \rangle$ to a diagram
  \begin{equation*}
    \begin{tikzcd}[row sep=small, column sep=tiny]
      &&& \respace{\langle p \rangle}
      \\
      && \respace{\iddots}
      \arrow[ur]
      && \respace{\ddots}
      \arrow[ul, equals]
      \\
      & \respace{\langle n \rangle}
      \arrow[ur]
      && \respace{\iddots}
      \arrow[ur]
      && \respace{\langle p \rangle}
      \arrow[ul, equals]
      \\
      \langle m \rangle
      \arrow[ur]
      && \respace{\langle n \rangle}
      \arrow[ul, equals]
      \arrow[ur]
      && \respace{\dots}
      && \respace{\langle p \rangle}
      \arrow[ul, equals]
    \end{tikzcd},
  \end{equation*}
  where we have drawn the morphisms in the span as belonging to $\Finp$ rather than $\Finp\op$.
\end{lemma}

\subsubsection*{Triple structure on \texorpdfstring{$\S_{\times}$}{S}}

Next, we define a triple structure on $\S_{\times}$.

\begin{definition}
  We define a triple $\triple{P}$ as follows.
  \begin{itemize}
    \item $\mathcal{P} = \mathcal{S}_{\times}$

    \item $\mathcal{P}\downdag = \mathcal{S}_{\times} \times_{\Finp\op} (\Finp\op)^{\simeq}$

    \item $\mathcal{P}\updag = \mathcal{S}_{\times}$
  \end{itemize}
\end{definition}

Here, we do not restrict the legs of our spans at all, except to ensure that $p$ restricts to a map $p\downdag\colon \category{P}\downdag \to \category{F}\downdag$.

Next, we need to show that the triple $\triple{P}$ is adequate. For this we need a few lemmas.

\begin{lemma}
  \label{lemma:spaces_fibration_admits_relative_pullbacks}
  The cartesian fibration $p\colon \S_{\times} \to \Finp\op$ admits relative pullbacks.
\end{lemma}
\begin{proof}
  By \cite[Cor.\ 4.3.1.11]{highertopostheory}, it suffices to show that each fiber $(\S_{\times})_{\langle n \rangle}$ admits pullbacks, and that for each map $\phi\colon \langle m \rangle \leftarrow \langle n \rangle$ in $\Finp\op$, the map $\phi^{*}\colon (\S_{\times})_{\langle m \rangle} \to (\S_{\times})_{\langle n \rangle}$ preserves pullbacks. By the defintion of the cocartesian monoidal structure on $\S\op$, we have an isomorphism  $(\S_{\times})_{\langle n \rangle} \cong \S^{n}$, and $\S^{n}$ admits pullbacks. Hence, each fiber admits pullbacks.

  Now we show that for any map $\phi\colon \langle m \rangle \leftarrow \langle n \rangle$ in $\Finp\op$, the map $\phi^{*}$ preserves pullbacks. Unravelling the definitions, we find that $\phi^{*}$ sends an object $(X_{1}, \ldots, X_{m}) \in \left( \S_{\times} \right)_{\langle m \rangle}$ to an object $(Y_{1}, \ldots, Y_{n}) \in (\S_{\times})_{\langle n \rangle}$ such that
  \begin{equation*}
    X_{i} \simeq \prod_{\phi(j) = i} Y_{j},
  \end{equation*}
  and the action on higher simplices is determined by the universal property for products. Since pullbacks in $\S^{m}$ are level-wise pullbacks in $\S$ and products commute with pullbacks, the result follows.
\end{proof}

\begin{lemma}
  \label{lemma:existence_and_preservation_of_limits}
  Let $p\colon \category{C} \to \category{D}$ be a cartesian fibration between quasicategories, and let $K$ be a simplicial set. Suppose that $\category{D}$ admits all $K$-shaped limits, and that $p$ admits all relative $K$-shaped limits. Then the following hold.
  \begin{enumerate}
    \item The quasicategory $\category{C}$ admits all $K$-shaped limits.

    \item The map $p$ preserves all $K$-shaped limits.
  \end{enumerate}
\end{lemma}
\begin{proof}
  \begin{enumerate}
    \item For any diagram $q\colon K \to \category{C}$, the diagram $p \circ q\colon K \to \category{D}$ admits a limit cone $\overline{p \circ q}\colon K\cone \to \category{D}$, and this data admits a relative $p$-limit cone $\bar{q}$ as below.
      \begin{equation*}
        \begin{tikzcd}
          K
          \arrow[r, "q"]
          \arrow[d, hook]
          & \category{C}
          \arrow[d, "p"]
          \\
          K\cone
          \arrow[r, swap, "\overline{p \circ q}"]
          \arrow[ur, dashed, "\bar{q}"]
          & \category{D}
        \end{tikzcd}
      \end{equation*}
      This is a limit cone for $q$ by \cite[Prop.\ 4.3.1.5]{highertopostheory}.

    \item Let $\bar{q}\colon K\cone \to \category{C}$ be a limit cone, and write $q = \bar{q}|_{K}$. We need to show that $p \circ \bar{q}\colon K\cone \to \category{D}$ is a limit cone in $\category{D}$. The restriction $p \circ q\colon K \to \category{D}$ admits a limit cone $\widehat{p \circ q}\colon K\cone \to \category{D}$, which admits a relative lift to a limit cone $\hat{q}\colon K\cone \to \category{C}$. But $\bar{q}$ and $\hat{q}$ are both limit cones of $q$, hence are equivalent as objects of $\Map(K\cone, \category{C})$ (by \cite[Prop.\ 4.3.1.5]{highertopostheory}). Therefore, $\widehat{p \circ q} = p \circ \hat{q}$ and $p \circ \bar{q}$ are equivalent as objects of $\Map(K\cone, \category{D})$, so $p \circ \bar{q}$ is a limit cone since $\widehat{p \circ q}$ is.
  \end{enumerate}
\end{proof}

\begin{proposition}
  The triple $\triple{P}$ is adequate.
\end{proposition}
\begin{proof}
  We check the conditions of \hyperref[def:adequate_triple]{Definition~\ref*{def:adequate_triple}}.
  \begin{enumerate}
    \item The category $\S_{\times}$ admits all pullbacks by \hyperref[lemma:spaces_fibration_admits_relative_pullbacks]{Lemma~\ref*{lemma:spaces_fibration_admits_relative_pullbacks}}, hence certainly admits ambigressive pullbacks.

    \item We need to show that for any pullback square in $\S_{\times}$
      \begin{equation*}
        \begin{tikzcd}
          X
          \arrow[r]
          \arrow[d, swap, "f"]
          & X'
          \arrow[d, "f'"]
          \\
          Y
          \arrow[r]
          & Y'
        \end{tikzcd}
      \end{equation*}
      such that $f$ lies over an isomorphism in $\Finp\op$, so does $f'$. But \hyperref[lemma:existence_and_preservation_of_limits]{Lemma~\ref*{lemma:existence_and_preservation_of_limits}} implies that the above square lies over a pullback square in $\Finp\op$, and the pullback of an isomorphism is an isomorphism.
  \end{enumerate}
\end{proof}

\subsubsection*{Triple structure on \texorpdfstring{$\Fun(\Delta^{1}, \S)_{\times}$}{Fun}}

Lastly, we define a triple structure on $\Map(\Delta^{1}, \S)_{\times}$.
\begin{definition}
  We define a triple $\triple{Q}$ as follows.
  \begin{itemize}
    \item $\mathcal{Q} = \Map(\Delta^{1}, \S)_{\times}$.

    \item $\mathcal{Q}\downdag$ is given by the pullback
      \begin{equation*}
        \begin{tikzcd}
          \mathcal{Q}\downdag
          \arrow[r]
          \arrow[d]
          & \mathcal{Q}
          \arrow[d, "{(q, \ev_{0})}"]
          \\
          (\Finp\op)^{\simeq} \times \S_{\times}^{\simeq}
          \arrow[r]
          & \Finp\op \times \S_{\times}
        \end{tikzcd}.
      \end{equation*}

    \item $\mathcal{Q}\updag = \mathcal{Q}$.
  \end{itemize}
\end{definition}

\begin{lemma}
  The functor $q\colon \Fun(\Delta^{1}, \S)_{\times} \to \Finp\op$ admits relative pullbacks.
\end{lemma}
\begin{proof}
  We need to show that each fiber $(\Fun(\Delta^{1}, \S)_{\times})_{\langle n \rangle}$ admits pullbacks. Using the isomorphisms $(\S_{\times})_{\langle n \rangle} \simeq \S^{n}$, we find isomorphisms
  \begin{equation*}
    (\Fun(\Delta^{1}, \S)_{\times})_{\langle n \rangle} \cong \Fun(\Delta^{1}, \S)^{n}.
  \end{equation*}
  The proof of \hyperref[lemma:spaces_fibration_admits_relative_pullbacks]{Lemma~\ref*{lemma:spaces_fibration_admits_relative_pullbacks}} then applies to our situation, with $\S$ replaced by $\Fun(\Delta^{1}, \S)$.
\end{proof}

\begin{lemma}
  The triple $\triple{Q}$ is adequate.
\end{lemma}
\begin{proof}
  We check the conditions of \hyperref[def:adequate_triple]{Definition~\ref*{def:adequate_triple}}.
  \begin{enumerate}
    \item Since $q$ admits relative pullbacks and $\Finp\op$ admits pullbacks, \hyperref[lemma:existence_and_preservation_of_limits]{Lemma~\ref*{lemma:existence_and_preservation_of_limits}} implies that $\Fun(\Delta^{1}, \S)_{\times}$ admits all pullbacks, hence certainly ambigressive pullbacks.

    \item Consider a pullback square in $\Fun(\Delta^{1}, \S)_{\times}$ corresponding to a cube in $\S_{\times}$
      \begin{equation}
        \label{eq:cube_in_Q}
        \begin{tikzcd}
          S'
          \arrow[rr, "F"]
          \arrow[dd]
          \arrow[dr]
          && T'
          \arrow[dd]
          \arrow[dr]
          \\
          & S
          \arrow[rr, crossing over, near start, "f"]
          && T
          \arrow[dd]
          \\
          X'
          \arrow[dr]
          \arrow[rr]
          && Y'
          \arrow[dr]
          \\
          & X
          \arrow[from=uu, crossing over]
          \arrow[rr]
          && Y
        \end{tikzcd},
      \end{equation}
      and which is lying over a square
      \begin{equation}
        \label{eq:square_in_finp_under_Q}
        \begin{tikzcd}
          \langle n \rangle
          & \langle n' \rangle
          \arrow[l, swap, "\psi"]
          \\
          \langle m \rangle
          \arrow[u]
          & \langle m' \rangle
          \arrow[l, swap, "\phi"]
          \arrow[u]
        \end{tikzcd}
      \end{equation}
      in $\Finp\op$. We need to show that (a) if $f$ is an equivalence, then $F$ is an equivalence, and (b) if $\phi$ is an equivalence, then $\psi$ is an equivalence.
      \begin{enumerate}
        \item By \cite[Cor.\ 4.3.1.15]{highertopostheory} with $\category{C} = \Fun(\Delta^{1}, \S_{\times})$, $\category{D} = \category{E} = \Fun(\Delta^{1}, \Finp\op)$, and $\category{E}_{0} = \Finp\op$, the cube in \hyperref[eq:cube_in_Q]{Diagram~\ref*{eq:cube_in_Q}} corresponds to a pullback diagram in $\Fun(\Delta^{1}, \S)_{\times}$ if and only if it corresponds to a pullback square in $\Fun(\Delta^{1}, \S_{\times})$, which in turn is true if and only if the top and bottom squares are pullback in $\S_{\times}$. The result follows because pullbacks preserve equivalences.

        \item \hyperref[lemma:existence_and_preservation_of_limits]{Lemma~\ref*{lemma:existence_and_preservation_of_limits}} implies that the square in \hyperref[eq:square_in_finp_under_Q]{Diagram~\ref*{eq:square_in_finp_under_Q}} is pullback (in $\Finp\op$), and the result again follows because pullbacks preserve equivalences.
      \end{enumerate}
  \end{enumerate}
\end{proof}

As we have defined them, it is clear that $p$, $q$, and $r$ restrict to maps
\begin{equation*}
  \begin{tikzcd}[column sep=small]
    \mathcal{M}_{\dagger}
    \arrow[r, "r_{\dagger}"]
    \arrow[rr, swap,  bend right, "q_{\dagger}"]
    & \mathcal{P}_{\dagger}
    \arrow[r, "q_{\dagger}"]
    & \mathcal{F}_{\dagger}
  \end{tikzcd}
  \qquad\text{and}\qquad
  \begin{tikzcd}[column sep=small]
    \mathcal{M}^{\dagger}
    \arrow[r, "r^{\dagger}"]
    \arrow[rr, swap,  bend right, "q^{\dagger}"]
    & \mathcal{P}^{\dagger}
    \arrow[r, "q^{\dagger}"]
    & \mathcal{F}^{\dagger}
  \end{tikzcd},
\end{equation*}
and preserve ambigressive pullback squares.


\subsection{Building categories of spans}
\label{ssc:building_categories_of_spans}

We have now constructued the following diagram of adequate triples and maps between them.
\begin{equation*}
  \begin{tikzcd}
    \triple{Q}
    \arrow[rr, "r"]
    \arrow[dr, swap, "q"]
    && \triple{P}
    \arrow[dl, "p"]
    \\
    & \triple{F}
  \end{tikzcd}
\end{equation*}

By construction, this gives us a commuting triangle
\begin{equation}
  \label{eq:commuting_diagram_of_spans}
  \begin{tikzcd}
    \Span\triple{Q}
    \arrow[rr, "\rho'"]
    \arrow[dr, swap, "\varpi'"]
    && \Span\triple{P}
    \arrow[dl, "\pi'"]
    \\
    & \Span\triple{F}
  \end{tikzcd}.
\end{equation}
Our next step is to show that the maps $\pi'$, $\rho'$, and $\varpi'$ are cocartesian fibrations. To do this, we need to exhibit that they admit enough cocartesian lifts; the form of these lifts will be given by \hyperref[thm:main]{Theorem~\ref*{thm:main}}, assuming we can show that this theorem applies.

\begin{lemma}
  The morphism $p$ satisfies the conditions of \hyperref[thm:main]{Theorem~\ref*{thm:main}}.
\end{lemma}
\begin{proof}
  We check the conditions.
  \begin{enumerate}
    \item We have to show that for any isomorphism in $\Finp\op$, there exists a $p$-cocartesian lift. But since every morphism in $\mathcal{F}_{\dagger} = (\Finp\op)^{\simeq}$ is an equivalence, it suffices to find a $p$-cartesian lift, which is possible because $p$ is a cartesian fibration.

    \item We need to show that for any commutative square
      \begin{equation*}
        \sigma \ = \quad
        \begin{tikzcd}
          S'
          \arrow[r, "f"]
          \arrow[d]
          & T'
          \arrow[d]
          \\
          S
          \arrow[r, "\simeq"]
          & T
        \end{tikzcd}
      \end{equation*}
      lying over a square
      \begin{equation*}
        \begin{tikzcd}
          \langle n \rangle
          & \langle n \rangle
          \arrow[l, swap, "\cong"]
          \\
          \langle m \rangle
          \arrow[u]
          & \langle m \rangle
          \arrow[l, swap, "\cong"]
          \arrow[u]
        \end{tikzcd}
      \end{equation*}
      in $\Finp\op$ (where we have drawn the arrows as belonging to $\Finp$), $\sigma$ is a pullback square if and only if $f$ is $p$-cocartesian. But $f$ is lying over an equivalence, so it is $p$-cocartesian if and only if it is an equivalence, which in turn is true if and only if the square in question is pullback.
  \end{enumerate}
\end{proof}

\begin{lemma}
  The morphism $q$ satisfies the conditions of \hyperref[thm:main]{Theorem~\ref*{thm:main}}.
\end{lemma}
\begin{proof}
  We have to check the conditions of the \hyperref[thm:main]{Theorem~\ref*{thm:main}}:
  \begin{enumerate}
    \item We have to show that for any isomorphism $\phi$ in $\Finp\op$, there exists a $q$-cocartesian lift. It follows from the $2/3$ property for equivalences that such a lift will automatically be $q\downdag$-cocartesian. But because $\phi$ is an equivalence, it suffices to find a $q$-cartesian lift, which is possible because $q$ is a cartesian fibration.

    \item We need to show that for any commutative square in $\Map(\Delta^{1}, \S)_{\times}$ corresponding to a cube in $\S_{\times}$ of the form
      \begin{equation*}
        \begin{tikzcd}
          X'
          \arrow[rr, "F"]
          \arrow[dd]
          \arrow[dr]
          && Y'
          \arrow[dd]
          \arrow[dr]
          \\
          & X
          \arrow[rr, crossing over, near start, "\simeq"]
          && Y
          \arrow[dd]
          \\
          S'
          \arrow[dr]
          \arrow[rr, near start, "f"]
          && T'
          \arrow[dr]
          \\
          & S
          \arrow[from=uu, crossing over]
          \arrow[rr, "\simeq"]
          && T
        \end{tikzcd}
      \end{equation*}
      and lying over a square in $\Finp\op$ of the form
      \begin{equation*}
        \begin{tikzcd}
          \langle n \rangle
          & \langle n \rangle
          \arrow[l, swap, "\cong"]
          \\
          \langle m \rangle
          \arrow[u]
          & \langle m \rangle
          \arrow[l, swap, "\cong"]
          \arrow[u]
        \end{tikzcd},
      \end{equation*}
      the morphism $(F, f)$ is $p$-cocartesian if and only if the top and bottom squares are pullback and $\psi$ is $p$-cocartesian. But this again follows because equivalences are $p$-cocartesian, and cocartesian morphisms are closed under composition.
  \end{enumerate}
\end{proof}

\begin{lemma}
  The map $r$ satisfies the conditions of \hyperref[thm:main]{Theorem~\ref*{thm:main}}.
\end{lemma}
\begin{proof}
  \leavevmode
  \begin{enumerate}
    \item It suffices to show that for each morphism $T \to S'$ in $\S_{\times}$ lying over $\langle m \rangle \overset{\cong}{\leftarrow} \langle m \rangle$ and each $Y \to T$ in the fiber over $\langle m \rangle$, the square
      \begin{equation*}
        \begin{tikzcd}
          Y
          \arrow[r, equals]
          \arrow[d]
          & Y
          \arrow[d]
          \\
          T
          \arrow[r]
          & S'
        \end{tikzcd}
      \end{equation*}
      is both $p$-cocartesian and $p_{\dagger}$-cocartesian, both of which follow from \hyperref[lemma:map_on_cartesian_cats_is_bicart_fib]{Lemma~\ref*{lemma:map_on_cartesian_cats_is_bicart_fib}}.

    \item We need to show that for any commutative square in $\Map(\Delta^{1}, \S)_{\times}$ corresponding to a cube in $\S_{\times}$ of the form
      \begin{equation*}
        \begin{tikzcd}
          X'
          \arrow[rr, "F"]
          \arrow[dd]
          \arrow[dr]
          && Y'
          \arrow[dd]
          \arrow[dr]
          \\
          & X
          \arrow[rr, crossing over, near start, "\simeq"]
          && Y
          \arrow[dd]
          \\
          S'
          \arrow[dr]
          \arrow[rr, near start, "f"]
          && T'
          \arrow[dr]
          \\
          & S
          \arrow[from=uu, crossing over]
          \arrow[rr]
          && T
        \end{tikzcd}
      \end{equation*}
      where the bottom square is pullback, the morphism $(F, f)$ is $r$-cocartesian if and only if the top square is pullback and $\psi$ is an equivalence. This is clear.
  \end{enumerate}
\end{proof}

\hyperref[thm:main]{Theorem~\ref*{thm:main}} then tells us immediately that the maps in \hyperref[eq:commuting_diagram_of_spans]{Diagram~\ref*{eq:commuting_diagram_of_spans}} are inner fibrations. Thus, in order to show that they are cocartesian fibrations, it suffices to exhibit sufficient cocartesian lifts.

\begin{proposition}
  The maps $\pi'$, $\varpi'$, and $\rho'$ are cocartesian fibrations.
\end{proposition}
\begin{proof}
  We need to check that each of $\pi'$, $\varpi'$, and $\rho'$ admits enough cocartesian lifts. \hyperref[thm:main]{Theorem~\ref*{thm:main}} provides a sufficient condition that morphisms be cocartesian, so we can simply check that lifts of these forms exist. Fix be a morphism
  \begin{equation*}
    \phi =
    \begin{tikzcd}
      \langle m \rangle
      \arrow[r]
      & \langle n \rangle
      & \langle n \rangle
      \arrow[l, swap, "\simeq"]
    \end{tikzcd}
  \end{equation*}
  in $\Span\triple{F}$, and a morphism
  \begin{equation*}
    \Gamma =
    \begin{tikzcd}
      S
      & T
      \arrow[l]
      \arrow[r]
      & S'
    \end{tikzcd}
  \end{equation*}
  in $\Span\triple{P}$
  \begin{itemize}
    \item Given an object $X$ in $\Span\triple{P}$ lying over $\langle m \rangle$, \hyperref[thm:main]{Theorem~\ref*{thm:main}} tells us that a $\pi'$-cocartesian lift of $\phi$ is of the form
      \begin{equation*}
        \begin{tikzcd}
          X
          & Y
          \arrow[l, swap, "f"]
          \arrow[r, "\simeq"]
          & X'
        \end{tikzcd},
      \end{equation*}
      where $f$ is $p$-cartesian. Such lifts always exist because $p$ is a cartesian fibration.

    \item Given an object $S \to X$ in $\Span\triple{Q}$ lying over $\langle m \rangle$, a $\varpi'$-cocartesian lift of $\phi$ is of the form
      \begin{equation*}
        \begin{tikzcd}
          S
          \arrow[d]
          & T
          \arrow[l, swap, "F"]
          \arrow[r, "\simeq"]
          \arrow[d]
          & S'
          \arrow[d]
          \\
          X
          & Y
          \arrow[l, swap, "f"]
          \arrow[r, "\simeq"]
          & X'
        \end{tikzcd},
      \end{equation*}
      where $F$ and $f$ are $p$-cartesian (i.e.\ the left-hand square corresponds to a $q$-cartesian morphism in $\Fun(\Delta^{1}, \S)_{\times}$). Such lifts automatically exist because $q$ is a cartesian fibration.

    \item Given an object $S \to X$ in $\Span\triple{Q}$ lying over $\langle m \rangle$, a $\rho'$-cocartesian lift of $\phi$ is of the form
      \begin{equation*}
        \begin{tikzcd}
          S
          \arrow[d]
          & S \times_{X} Y
          \arrow[l]
          \arrow[r, "\simeq"]
          \arrow[d]
          & S'
          \arrow[d]
          \\
          X
          & Y
          \arrow[l]
          \arrow[r]
          & X'
        \end{tikzcd},
      \end{equation*}
      where the left-hand square is pullback. Such lifts exist because $\S_{\times}$ admits pullbacks.
  \end{itemize}
\end{proof}

Recall that there is an equivalence $\Finp \to \Span\triple{F}$. Pulling back \hyperref[eq:commuting_diagram_of_spans]{Diagram~\ref*{eq:commuting_diagram_of_spans}} along this map gives a diagram of cocartesian fibrations
\begin{equation*}
  \begin{tikzcd}
    P
    \arrow[rr, "\rho"]
    \arrow[dr, swap, "\varpi"]
    && Q
    \arrow[dl, "\pi"]
    \\
    & \Finp
  \end{tikzcd}.
\end{equation*}

\begin{proposition}
  The maps $\pi$ and $\varpi$ are monoidal structures.
\end{proposition}
\begin{proof}
  We consider the case of $\pi$. We need to show that the pushforward functors corresponding to the inert maps $\rho_{i}\colon \langle n \rangle \to \langle 1 \rangle$ induce an equivalence $P_{\langle n \rangle} \simeq P_{\langle 1 \rangle}^{n}$. These maps send (up to equivalence) $[X_{1}, \ldots, X_{n}] \mapsto X_{i}$, giving an isomorphism $P_{\langle n \rangle} \cong P_{\langle 1 \rangle}^{n}$.

  The case of $\varpi$ is similar.
\end{proof}

\subsection{Building the functor \texorpdfstring{$\hat{r}$}{r}}
\label{ssc:building_the_functor}

We are now ready to build the lax monoidal functor $\hat{r}\colon \Span(\S) \to \ICat$, as discussed in \hyperref[ssc:introduction]{Subsection~\ref*{ssc:introduction}}. Restricting the functor $\rho$ to the component lying over $\langle 1 \rangle \in \Finp$ gives a cocartesian fibration $\rho_{\langle 1 \rangle\colon }Q_{\langle 1 \rangle} \to P_{\langle 1 \rangle}$, which classifies a functor $P_{\langle 1 \rangle} \to \ICat$. This will be almost the functor we need.

\begin{proposition}
  There is an isomorphism of simplicial sets $P_{\langle 1 \rangle} \cong \Span(\S)$.
\end{proposition}
\begin{proof}
  The $n$-simplices of $P_{\langle 1 \rangle}$ are ambigressive cartesian maps $\sigma\colon \sd(\Delta^{n}) \to \S_{\times}$ making the diagram
  \begin{equation*}
    \begin{tikzcd}
      \sd(\Delta^{n})
      \arrow[rr, "\sigma"]
      \arrow[dr, swap, "\const_{\langle 1 \rangle}"]
      && \S_{\times}
      \arrow[dl]
      \\
      & \Finp\op
    \end{tikzcd}
  \end{equation*}
  commute. The condition that the diagram commute is the condition that $\sigma$ land in $(\S_{\times})_{\langle 1 \rangle} \simeq \S$, and the ambigressiveness condition is that the forward-facing legs in $\sigma$ lie over equivalences in $\Finp\op$, which is automatic.
\end{proof}

\begin{proposition}
  For any $X \in P_{\langle 1 \rangle}$, there is an equivalence
  \begin{equation*}
    (Q_{\langle 1 \rangle})_{X} \simeq (\S_{/X})\op.
  \end{equation*}
\end{proposition}
\begin{proof}
  The $n$-simplices of $(Q_{\langle 1 \rangle})_{X}$ are ambigressive cartesian maps $\sigma\colon \sd(\Delta^{n}) \to \Fun(\Delta^{1}, \S)_{\times}$ such that the diagrams
  \begin{equation*}
    \begin{tikzcd}
      \sd(\Delta^{n})
      \arrow[rr, "\sigma"]
      \arrow[dr, swap, "\const_{\langle 1 \rangle}"]
      && \Fun(\Delta^{1}, \S)_{\times}
      \arrow[dl]
      \\
      & \Finp\op
    \end{tikzcd}
  \end{equation*}
  and
  \begin{equation*}
    \begin{tikzcd}
      \sd(\Delta^{n})
      \arrow[rr, bend left, "\const_{X}"]
      \arrow[r, "\sigma"]
      & \Fun(\Delta^{1}, \S)_{\times}
      \arrow[r, "\ev_{1}"]
      & \S_{\times}
    \end{tikzcd}
  \end{equation*}
  commute. The first diagram ensures that $\sigma$ lands entirely inside $(\Fun(\Delta^{1}, \S)_{\times})_{\langle 1 \rangle} \cong \Fun(\Delta^{1}, \S)$, so $\sigma$ is equivalently a map $\sd(\Delta^{n}) \times \Delta^{1} \to \S$ such that:
  \begin{itemize}
    \item The composition
      \begin{equation*}
        \sd(\Delta^{n}) \times \Delta^{\{1\}} \hookrightarrow \sd(\Delta^{n}) \times \Delta^{1} \to \S
      \end{equation*}
      is equal to $\const_{X}$.

    \item The forward-facing legs in $\sd(\Delta^{n}) \times \Delta^{\{0\}}$ are mapped to equivalences in $\S$.
  \end{itemize}
  This is precisely the data of a map $\sd(\Delta^{n}) \diamond \Delta^{0} \to \S$ sending $\Delta^{0} \mapsto X$, and such that and the forward-facing legs of $\sd(\Delta^{n})$ are sent to equivalences in $\S$. But these are precisely the $n$-simplices of $\Span_{\simeq}(\S^{/X})$. The equvialence $(\S^{/X})\op \to \Span_{\simeq}(\S^{/X})$ and $\S_{/X} \simeq \S^{/X}$ now give us the equivalence that we want.
\end{proof}

We now define $R$ to be the functor classified by the cocartesian fibration $\rho$. On objects, this functor sends a space $X$ to the category $(\S_{/X})\op$. A morphism in $\Span(\S)$ represented by a span of spaces
\begin{equation*}
  \begin{tikzcd}
    X
    & Y
    \arrow[l, swap, "g"]
    \arrow[r, "f"]
    & X'
  \end{tikzcd}
\end{equation*}
is sent to the functor $(\S_{/X})\op \to (\S_{/X'})\op$ defined by sending an object $S \to X$ to the object $S' \to X'$ defined up to equivalence as follows.
\begin{equation*}
  \begin{tikzcd}
    S
    \arrow[d]
    & S \times_{X} Y
    \arrow[l]
    \arrow[r, "\simeq"]
    \arrow[d]
    & S'
    \arrow[d]
    \\
    X
    & Y
    \arrow[l, swap, "g"]
    \arrow[r, "f"]
    & X'
  \end{tikzcd}
\end{equation*}
This is almost what we want, up to an $\mathrm{op}$: we would like our functor $\hat{r}$ to send $X \mapsto \S_{/X}$ rather than $(\S_{/X})\op$. Fortunately, this is only an inconvenience. Recall that there is an autoequivalence of $\ICat$ sending $\category{C} \mapsto \category{C}\op$.
\begin{definition}
  We define the map $\hat{r}\colon \Span(\S) \to \ICat$ to be the composition
  \begin{equation*}
    \begin{tikzcd}
      \Span(\S)
      \arrow[r, "R"]
      & \ICat
      \arrow[r, "\mathrm{op}"]
      & \ICat
    \end{tikzcd}.
  \end{equation*}
\end{definition}

The map $R$ is lax monoidal by \cite{luriehigheralgebra}, 2.4.2.4--2.4.2.6, and the map $R$ is lax monoidal because it is an equivalence, so $\hat{r}$ is lax monoidal.

\end{document}
